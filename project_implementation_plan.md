# プロジェクト機能 実装計画

## 目的
- プロジェクト単位でタスクを管理し、進行状況を定量的に把握できるようにする。
- KPIが「どのように算出されるか」「どこから来る値か」が明確に伝わるUIとAPIにする。
- 将来的にチーム運用・リアルタイム可視化・AIによるKPI選定へ拡張できる土台を作る。

## 現状
- プロジェクトに `kpi_config` を保存できる。
- KPIテンプレはAPIで取得可能。
- UIでKPIの追加/編集が可能だが、意味が不明瞭な項目がある。
- KPIの現在値は計算されず、入力値に頼っている。

## 課題
- KPIの計算ロジックが存在しないため「現在値」が不明。
- `key` / `source` / `strategy` の意味がUI上で伝わりづらい。
- `AI` 戦略は機能が未実装のため混乱を招く。
- タスク起点のKPIは自動計算されるべき。

## 進め方（フェーズ）
### フェーズ1: KPI計算基盤の実装（今回）
- KPI定義とタスクデータを結びつけて現在値を自動算出。
- タスク起点のKPIは自動計算し、UIで編集不可にする。
- 手動KPIは手入力可能として区別する。
- AIエージェントがプロジェクトを作成できる `create_project` ツールを追加し、要約・KPIテンプレ選定を実装。

### フェーズ2: KPI入力体験の改善
- `key` / `source` / `strategy` の説明文・ヘルプを追加。
- 戦略の選択は意味に合わせて挙動を変更（テンプレ/カスタム）
- `AI` 戦略は「準備中」と表示して選択不可にするか、説明を明確化する。

### フェーズ3: チーム・リアルタイム対応
- プロジェクトに「メンバー」「役割」「KPI更新権限」を追加。
- SSE/WebSocketでKPI・タスクの変更をリアルタイム反映。

## データモデル方針
- `Project.kpi_config` に KPI の設定（戦略/テンプレ/指標）を保存。
- KPIの計算結果は保存せず、API応答時に動的算出。
- 手動KPIの `current` は保存値を優先。

## KPI計算仕様（タスク起点）
以下のキーはタスクから自動算出する。

- `completion_rate`: 完了率 = 完了タスク / 総タスク * 100
- `overdue_tasks`: 期限超過タスク数（期限 < 現在、かつ未完了）
- `remaining_hours`: 残作業時間 = 未完了タスクの見積合計（分→時間）
- `weekly_throughput`: 直近7日で完了したタスク数（DONEかつ更新日が7日以内）
- `wip_count`: 進行中タスク数（IN_PROGRESS）
- `blocked_tasks`: 待機中タスク数（WAITING）＋依存が未完了のタスク数
- `backlog_count`: 未完了タスク総数（TODO/IN_PROGRESS/WAITING）

## KPI計算仕様（手動）
- `source=manual` のKPIは `current` を手入力で保持。
- SLAや営業などの指標は後続フェーズでイベント記録の追加が必要。

## API設計方針
- 取得時に `kpi_config.metrics[].current` を自動計算して返す。
- 既存の `GET /api/projects` と `GET /api/projects/{id}` に反映する。
- 変更時は `kpi_config` をそのまま保存する（manualのcurrent値のみ）。
- エージェント用に `create_project` ツールを追加し、`ProjectCreate` を生成してAPI呼び出しできるようにする。

## UI方針
- `source=tasks` のKPIは現在値を編集不可。
- `source=manual` のKPIは手入力可能。
- `key` は内部識別子として説明文を表示（必要であれば非表示化）。
- `strategy` には補足テキストを付け、AIは「準備中」表示。

## 成果物
- KPI計算サービス
- APIレスポンスへ自動計算値を埋め込み
- KPI入力UIの意味・入力可否を明確化
- エージェント向け `create_project` ツール実装
